<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <!-- Mobile Optimization -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Worldview Studio - Urban Fantasy</title>
    <!-- Fixed: Clean URL for FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --bg-input: #2c2c2c;
            --accent-color: #7c4dff; /* Mystic Purple */
            --accent-hover: #651fff;
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --border-color: #333333;
            --card-bg: #252525;
            --modal-bg: #1e1e1e;
            --danger-color: #ff5252;
            --slot-active: #7c4dff;
            --slot-inactive: #333333;
            --mobile-nav-height: 60px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden; /* Main container fixed */
        }

        /* --- Responsive Layout System --- */
        
        /* Desktop Styles */
        .left-panel {
            width: 360px;
            background-color: var(--bg-panel);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 24px;
            overflow-y: auto;
            flex-shrink: 0;
            height: 100%;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 40px;
            overflow-y: auto;
            height: 100%;
        }

        /* Mobile Navigation (Hidden on Desktop) */
        .mobile-nav {
            display: none; 
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--mobile-nav-height);
            background-color: var(--bg-panel);
            border-top: 1px solid var(--border-color);
            z-index: 1000;
            justify-content: space-around;
            align-items: center;
            padding-bottom: env(safe-area-inset-bottom); /* iPhone Home Bar safe area */
        }

        .nav-item {
            flex: 1;
            text-align: center;
            color: var(--text-sub);
            font-size: 0.8rem;
            padding: 8px 0;
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: var(--accent-color);
        }

        .nav-item i {
            display: block;
            font-size: 1.4rem;
            margin-bottom: 4px;
        }

        /* --- Mobile Styles (Media Query) --- */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                height: 100%;
                position: fixed; 
                width: 100%;
            }

            .mobile-nav {
                display: flex;
            }

            .left-panel, .right-panel {
                width: 100%;
                height: calc(100% - var(--mobile-nav-height)); 
                border-right: none;
                padding: 20px;
                padding-bottom: 80px;
                display: none; 
                position: absolute; 
                top: 0;
                left: 0;
                z-index: 1;
            }

            .left-panel.active-tab, .right-panel.active-tab {
                display: flex;
                z-index: 10;
            }

            .brand-title { font-size: 1rem; }
            .project-name { font-size: 1.2rem; margin-bottom: 15px; }
            .panel-title { font-size: 1.4rem; }
            
            .header-actions { gap: 8px; }
            .settings-btn span.desktop-only { display: none; }
            .settings-btn { padding: 8px 12px; }
            
            .input-area { padding: 15px; }
            textarea, input[type="text"], select {
                font-size: 16px !important; 
            }
            
            .modal {
                width: 100%;
                height: 100%;
                max-width: none;
                max-height: none;
                border-radius: 0;
                display: flex;
                flex-direction: column;
            }
            .modal-body {
                flex: 1;
                overflow-y: auto;
                padding-bottom: 50px;
            }
            .sheet-modal {
                width: 100%;
                height: 100%;
            }
            .sheet-grid {
                grid-template-columns: 80px 1fr; 
            }
        }

        /* --- Common Styles --- */

        .brand-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 8px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .project-name {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 20px;
            color: white;
        }

        /* Slot Selector */
        .slot-container {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .slot-label {
            font-size: 0.8rem;
            color: var(--text-sub);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .slot-btn {
            flex: 1;
            background-color: var(--slot-inactive);
            border: 1px solid var(--border-color);
            color: var(--text-sub);
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .slot-btn:hover {
            background-color: #444;
            color: white;
        }

        .slot-btn.active {
            background-color: var(--slot-active);
            color: white;
            border-color: var(--slot-active);
            box-shadow: 0 2px 8px rgba(124, 77, 255, 0.4);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 0.85rem;
            color: var(--text-sub);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .btn-group {
            display: flex;
            gap: 12px;
        }

        .icon-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-sub);
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            color: var(--accent-color);
            border-color: var(--accent-color);
            background-color: rgba(255,255,255,0.05);
        }

        .cards-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-bottom: 20px;
        }

        .info-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }

        .info-card:active {
            background-color: #333; 
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-actions {
            display: flex;
            gap: 12px;
            opacity: 0.9;
        }

        .action-icon {
            color: var(--text-sub);
            font-size: 1rem;
            padding: 8px; 
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .action-icon:hover { color: white; background-color: rgba(255,255,255,0.1); }
        .action-icon.delete:hover { color: var(--danger-color); background-color: rgba(255,82,82,0.1); }

        .card-desc {
            font-size: 0.9rem;
            color: var(--text-sub);
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .panel-title {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .settings-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-sub);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .settings-btn:hover {
            border-color: var(--text-main);
            color: var(--text-main);
        }

        .input-area {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .input-label {
            display: block;
            margin-bottom: 12px;
            font-size: 1rem;
            color: var(--text-main);
            font-weight: 500;
        }

        textarea, input[type="text"], input[type="password"], select {
            background-color: var(--bg-input);
            border: 1px solid transparent;
            border-radius: 8px;
            color: white;
            padding: 16px;
            font-size: 1rem;
            transition: border-color 0.3s;
            width: 100%;
        }

        textarea {
            height: 120px;
            resize: none;
            line-height: 1.6;
        }

        textarea:focus, input[type="text"]:focus, input[type="password"]:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }
        
        select option {
            background-color: var(--bg-panel);
            color: white;
            padding: 10px;
        }

        .action-btn {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
            margin-left: auto;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .action-btn:active {
            transform: translateY(0);
        }

        .result-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .action-btn.secondary {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-sub);
            padding: 10px 20px;
            font-size: 0.9rem;
            box-shadow: none;
            margin-top: 0;
        }

        .action-btn.secondary:hover {
            background-color: rgba(255,255,255,0.05);
            color: white;
            border-color: var(--text-main);
        }
        
        .action-btn.reflect {
            background: rgba(124, 77, 255, 0.1);
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
        }
        .action-btn.reflect:hover {
            background: var(--accent-color);
            color: white;
        }
        
        .action-btn.polish {
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            border: none;
            color: white;
        }

        /* Output Area */
        .output-container {
            background-color: var(--bg-panel);
            border-radius: 12px;
            padding: 30px;
            flex: 1;
            border: 1px solid var(--border-color);
            position: relative;
            min-height: 300px;
            overflow-y: auto;
        }

        .output-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #555;
            text-align: center;
            width: 100%;
        }

        .output-placeholder i {
            font-size: 3rem;
            margin-bottom: 16px;
            display: block;
        }

        .generated-content {
            display: none;
            animation: fadeIn 0.5s ease;
            white-space: pre-line; 
        }

        .generated-content h3 {
            color: var(--accent-color);
            margin-bottom: 16px;
            font-size: 1.2rem;
        }

        .chat-bubble {
            background-color: var(--bg-input);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid var(--accent-color);
            line-height: 1.6;
        }

        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 30, 30, 0.9);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            border-radius: 12px;
            backdrop-filter: blur(4px);
            z-index: 2000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Tags */
        .tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            background-color: rgba(124, 77, 255, 0.2);
            color: #b388ff;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 8px;
            margin-right: 4px;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .modal {
            background-color: var(--modal-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 450px;
            max-width: 90%;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            max-height: 85vh;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 12px;
            flex-shrink: 0;
        }

        .modal-body {
            overflow-y: auto;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-sub);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
        }

        .close-btn:hover { color: white; }

        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 8px; color: var(--text-sub); font-size: 0.9rem; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; flex-shrink: 0;}
        
        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-sub);
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
        }
        .btn-secondary:hover { background-color: rgba(255,255,255,0.05); color: white; }
        
        .btn-primary {
            background-color: var(--accent-color);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-primary:hover { background-color: var(--accent-hover); }

        .api-link {
            font-size: 0.8rem;
            color: var(--accent-color);
            text-decoration: none;
            margin-top: 8px;
            display: inline-block;
        }
        .api-link:hover { text-decoration: underline; }
        
        #fileUpload { display: none; }
        
        /* Custom Alert Modal */
        .alert-modal-body { text-align: center; padding: 20px 0; }
        .alert-message { color: white; margin-bottom: 20px; line-height: 1.5; }

        /* History List Styles */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .history-item {
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s;
        }
        .history-item:hover {
            border-color: var(--text-sub);
        }
        .history-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.8rem;
            color: var(--text-sub);
        }
        .history-event {
            font-weight: 600;
            color: white;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .history-preview {
            font-size: 0.9rem;
            color: var(--text-sub);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 12px;
        }
        .history-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .history-btn {
            font-size: 0.8rem;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-main);
        }
        .history-btn:hover { background: rgba(255,255,255,0.1); }
        .history-btn.delete:hover { color: var(--danger-color); border-color: var(--danger-color); }
        .empty-history { text-align: center; padding: 40px 0; color: var(--text-sub); }

        /* Export Sheet Styles (Based on Markdown Structure) */
        .sheet-modal {
            width: 210mm; /* A4 Width */
            max-width: 95%;
            height: 90vh;
            background-color: #fff; /* Paper White */
            color: #000; /* Black text for print */
            padding: 0;
            overflow: hidden;
        }
        .sheet-scroll {
            overflow-y: auto;
            height: 100%;
            padding: 40px;
        }
        .sheet-container {
            width: 100%;
            font-family: 'Pretendard', serif; 
            line-height: 1.6;
        }
        
        /* Sheet Header */
        .sheet-header-group {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            border-bottom: 3px solid #000;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        .sheet-title-main {
            font-size: 2.5rem;
            font-weight: 900;
            color: #000;
            margin: 0;
        }
        .sheet-meta-info {
            font-size: 0.9rem;
            color: #555;
            text-align: right;
        }

        /* Sheet Sections */
        .sheet-section {
            margin-bottom: 30px;
        }
        .sheet-section-title {
            font-size: 1.3rem;
            font-weight: 800;
            border-bottom: 1px solid #000;
            padding-bottom: 8px;
            margin-bottom: 15px;
            color: #222;
        }
        
        /* Input Groups in Sheet */
        .sheet-field {
            margin-bottom: 20px;
        }
        .sheet-field-label {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 6px;
            color: #000;
            display: block;
        }
        .sheet-field-input {
            width: 100%;
            border: 1px solid #ddd;
            padding: 10px;
            font-family: inherit;
            font-size: 0.95rem;
            background: #f9f9f9;
            border-radius: 4px;
            resize: vertical;
            color: #333;
        }
        .sheet-field-input:focus {
            outline: none;
            border-color: var(--accent-color);
            background: #fff;
        }
        .sheet-field-input.short {
            height: 40px;
        }
        .sheet-field-input.medium {
            height: 80px;
        }
        .sheet-field-input.long {
            height: 150px;
        }

        /* --- PRINT STYLES: FIX FOR CUTOFF --- */
        @media print {
            @page { 
                size: A4;
                margin: 15mm;
            }
            
            /* Reset main layout to avoid cutoff */
            body, html {
                background: white;
                width: 100%;
                height: auto !important;
                overflow: visible !important;
                position: static !important;
                display: block !important;
            }

            /* Hide non-print elements */
            .left-panel, .right-panel, .mobile-nav, 
            .modal-overlay:not(#exportModal), 
            .modal-header, .modal-footer, .close-btn,
            .settings-btn, .action-btn {
                display: none !important;
            }
            
            /* Force Export Modal to be the only visible content */
            #exportModal {
                display: block !important;
                position: static !important; /* Crucial: allows flow across pages */
                width: 100% !important;
                height: auto !important;
                background: white !important;
                z-index: 9999;
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
                overflow: visible !important;
            }
            
            .sheet-modal {
                width: 100% !important;
                height: auto !important;
                max-width: none !important;
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                overflow: visible !important;
            }
            
            .sheet-scroll {
                height: auto !important;
                overflow: visible !important;
                padding: 0 !important;
            }
            
            .sheet-container {
                width: 100% !important;
                margin: 0 !important;
            }
            
            /* Styling inputs for print */
            .sheet-field-input {
                border: none !important;
                background: transparent !important;
                resize: none !important;
                padding: 0 !important;
                margin: 0 !important;
                font-size: 11pt !important;
                line-height: 1.5 !important;
                /* Ensure full text visibility */
                height: auto !important; 
                overflow: visible !important;
                white-space: pre-wrap !important; 
                color: black !important;
                display: block !important;
            }
            
            .sheet-section {
                break-inside: avoid; /* Prevent awkward breaks inside sections */
                margin-bottom: 20px;
            }
        }
        
    </style>
</head>
<body>

    <!-- Left Panel: Worldview Info -->
    <aside class="left-panel active-tab" id="panelSettings">
        <div class="brand-title"><i class="fa-solid fa-book-open"></i> Story Archiver</div>
        <h1 class="project-name">Project:<br>Urban Fantasy</h1>

        <!-- Slot Selector -->
        <div class="slot-label">SAVE SLOTS</div>
        <div class="slot-container">
            <button class="slot-btn active" id="slot1" onclick="switchSlot(1)">1</button>
            <button class="slot-btn" id="slot2" onclick="switchSlot(2)">2</button>
            <button class="slot-btn" id="slot3" onclick="switchSlot(3)">3</button>
        </div>

        <div class="section-header">
            <div class="section-title">World Settings</div>
            <div class="btn-group">
                <button class="icon-btn" onclick="document.getElementById('fileUpload').click()" title="ÌååÏùº ÏóÖÎ°úÎìú">
                    <i class="fa-solid fa-file-import"></i>
                </button>
                <button class="icon-btn" onclick="openModal('paste')" title="ÌÖçÏä§Ìä∏ ÏßÅÏ†ë Î∂ôÏó¨ÎÑ£Í∏∞">
                    <i class="fa-solid fa-clipboard"></i>
                </button>
                <button class="icon-btn" onclick="openModal('edit')" title="ÏÑ§Ï†ï Ï∂îÍ∞Ä">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
            <input type="file" id="fileUpload" accept=".txt" onchange="handleFileUpload(this)">
        </div>
        
        <!-- Cards Container -->
        <div id="cardsContainer" class="cards-container"></div>
        
        <!-- Left Panel Loading Overlay -->
        <div id="leftLoading" class="loading-overlay" style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; border-radius: 0;">
             <div class="spinner"></div>
             <p id="leftLoadingText">Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Ï§ë...</p>
        </div>
    </aside>

    <!-- Right Panel: Episode Generator -->
    <main class="right-panel" id="panelGenerate">
        <div class="panel-header">
            <h2 class="panel-title">ÏóêÌîºÏÜåÎìú ÏÉùÏÑ± Ïä§ÌäúÎîîÏò§</h2>
            <div class="header-actions">
                <button class="settings-btn" onclick="openModal('export')">
                    <i class="fa-solid fa-file-pdf"></i> <span class="desktop-only">Í∏∞ÌöçÏÑú ÎÇ¥Î≥¥ÎÇ¥Í∏∞</span>
                </button>
                <button class="settings-btn" onclick="openModal('history')">
                    <i class="fa-solid fa-clock-rotate-left"></i> <span class="desktop-only">ÌûàÏä§ÌÜ†Î¶¨</span>
                </button>
                <button class="settings-btn" onclick="openModal('api')">
                    <i class="fa-solid fa-gear"></i> <span class="desktop-only">AI ÏÑ§Ï†ï</span>
                </button>
            </div>
        </div>

        <div class="input-area">
            <label class="input-label"><i class="fa-solid fa-pen-nib"></i> Î∞úÏÉù ÏÇ¨Í±¥ ÏûÖÎ†• (Trigger Event)</label>
            <textarea id="eventInput" placeholder="Ïòà) ÏùÑÏßÄÎ°ú 3Í∞Ä ÏßÄÌïòÏ≤†Ïó≠ÏóêÏÑú ÏõêÏù∏ Î∂àÎ™ÖÏùò ÎßàÎ†• Ìè≠Î∞ú ÏÇ¨Í≥†Í∞Ä Î∞úÏÉùÌñàÎã§."></textarea>
            <button class="action-btn" onclick="generateEpisode()">
                <i class="fa-solid fa-wand-magic-sparkles"></i> ÏóêÌîºÏÜåÎìú Ï∂îÏ∂úÌïòÍ∏∞
            </button>
        </div>

        <div class="section-title">GENERATED RESULT</div>
        <div class="output-container">
            <div id="placeholder" class="output-placeholder">
                <i class="fa-regular fa-file-lines"></i>
                <p>ÏÇ¨Í±¥ÏùÑ ÏûÖÎ†•ÌïòÍ≥† Ï∂îÏ∂ú Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Î©¥<br>AIÍ∞Ä ÏÑ§Ï†ïÏóê Í∏∞Î∞òÌïú ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÉùÏÑ±Ìï©ÎãàÎã§.</p>
            </div>
            <div id="loading" class="loading-overlay">
                <div class="spinner"></div>
                <p>ÏÑ∏Í≥ÑÍ¥Ä Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Ï§ë...</p>
                <p style="font-size: 0.8rem; color: var(--text-sub); margin-top: 8px;">Gemini AIÏôÄ ÌÜµÏã† Ï§ë</p>
            </div>
            <div id="resultContent" class="generated-content"></div>
        </div>
    </main>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav">
        <div class="nav-item active" onclick="switchMobileTab('settings')">
            <i class="fa-solid fa-book-open"></i>
            ÏÑ§Ï†ï
        </div>
        <div class="nav-item" onclick="switchMobileTab('generate')">
            <i class="fa-solid fa-pen-fancy"></i>
            ÏÉùÏÑ±
        </div>
    </nav>

    <!-- Edit/Create Modal -->
    <div id="editModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">ÏÑ§Ï†ï Ìé∏Ïßë</h3>
                <button class="close-btn" onclick="closeModal('edit')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="settingId">
                <div class="form-group">
                    <label class="form-label">ÏïÑÏù¥ÏΩò ÏÑ†ÌÉù</label>
                    <select id="settingIcon">
                        <option value="fa-solid fa-book">üìñ Í∏∞Î≥∏/ÏÑ§Ï†ï (Book)</option>
                        <option value="fa-solid fa-user">üë§ Ïù∏Î¨º (Person)</option>
                        <option value="fa-solid fa-user-secret">üïµÔ∏è ÏïÖÏó≠/Ïä§ÌååÏù¥ (Villain)</option>
                        <option value="fa-solid fa-users">üë• Îã®Ï≤¥/Ï°∞ÏßÅ (Group)</option>
                        <option value="fa-solid fa-city">üèôÔ∏è Î∞∞Í≤Ω/ÎèÑÏãú (City)</option>
                        <option value="fa-solid fa-location-dot">üìç Ïû•ÏÜå/ÏúÑÏπò (Location)</option>
                        <option value="fa-solid fa-bolt">‚ö° ÎßàÎ≤ï/Îä•Î†• (Magic)</option>
                        <option value="fa-solid fa-wand-magic-sparkles">‚ú® Ïã†ÎπÑ/Ïú†Î¨º (Artifact)</option>
                        <option value="fa-solid fa-gem">üíé ÏïÑÏù¥ÌÖú/Î≥¥ÏÑù (Item)</option>
                        <option value="fa-solid fa-shield-halved">üõ°Ô∏è Î∞©Ïñ¥/Í∑úÏπô (Rule)</option>
                        <option value="fa-solid fa-scroll">üìú Ïó≠ÏÇ¨/Í∏∞Î°ù (History)</option>
                        <option value="fa-solid fa-skull">üíÄ ÏúÑÌóò/Î™¨Ïä§ÌÑ∞ (Danger)</option>
                        <option value="fa-solid fa-heart">‚ù§Ô∏è Í¥ÄÍ≥Ñ/ÏÇ¨Îûë (Love)</option>
                        <option value="fa-solid fa-clock">‚è∞ ÏãúÍ∞Ñ/ÌÉÄÏûÑÎùºÏù∏ (Time)</option>
                        <option value="fa-solid fa-comment-dots">üí¨ ÎåÄÏÇ¨/Î™ÖÏñ∏ (Quote)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ï†úÎ™©</label>
                    <input type="text" id="settingTitle" placeholder="ÏÑ§Ï†ï Ï†úÎ™©">
                </div>
                <div class="form-group">
                    <label class="form-label">ÎÇ¥Ïö©</label>
                    <textarea id="settingDesc" style="height: 100px;" placeholder="ÏÉÅÏÑ∏ ÏÑ§Ï†ïÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">ÌÉúÍ∑∏ (ÏÑ†ÌÉù)</label>
                    <input type="text" id="settingTag" placeholder="Ïòà) Ï§ëÏöî, Ïù∏Î¨º, Í∑úÏπô">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('edit')">Ï∑®ÏÜå</button>
                <button class="btn-primary" onclick="saveSetting()">Ï†ÄÏû•ÌïòÍ∏∞</button>
            </div>
        </div>
    </div>

    <!-- Paste Text Modal -->
    <div id="pasteModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fa-solid fa-clipboard"></i> ÏÑ§Ï†ï ÏßÅÏ†ë Î∂ôÏó¨ÎÑ£Í∏∞</h3>
                <button class="close-btn" onclick="closeModal('paste')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ÏÑ§Ï†ï Îç∞Ïù¥ÌÑ∞ (ÏÑ∏Í≥ÑÍ¥Ä, Ï∫êÎ¶≠ÌÑ∞ Îì±)</label>
                    <textarea id="pasteInput" style="height: 200px;" placeholder="Î©îÎ™®Ïû•Ïù¥ÎÇò Î¨∏ÏÑúÏóê Ï†ÅÏñ¥Îëî ÎÇ¥Ïö©ÏùÑ Ïó¨Í∏∞Ïóê Î≥µÏÇ¨Ìï¥ÏÑú Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('paste')">Ï∑®ÏÜå</button>
                <button class="btn-primary" onclick="handlePasteAnalysis()">Î∂ÑÏÑù ÏãúÏûë</button>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="apiModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fa-solid fa-key"></i> AI Ïó∞Í≤∞ ÏÑ§Ï†ï</h3>
                <button class="close-btn" onclick="closeModal('api')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Google Gemini API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="AI StudioÏóêÏÑú Î∞úÍ∏âÎ∞õÏùÄ ÌÇ§Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="api-link">
                        <i class="fa-solid fa-external-link-alt"></i> Î¨¥Î£å API ÌÇ§ Î∞úÍ∏âÎ∞õÍ∏∞
                    </a>
                    <p style="font-size: 0.8rem; color: var(--text-sub); margin-top:8px;">
                        * ÌÇ§Îäî Î∏åÎùºÏö∞Ï†ÄÏóêÎßå Ï†ÄÏû•ÎêòÎ©∞ ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°ÎêòÏßÄ ÏïäÏäµÎãàÎã§.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('api')">Îã´Í∏∞</button>
                <button class="btn-primary" onclick="saveApiKey()">Ïó∞ÎèôÌïòÍ∏∞</button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal-overlay">
        <div class="modal" style="width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fa-solid fa-clock-rotate-left"></i> ÏÉùÏÑ± ÌûàÏä§ÌÜ†Î¶¨</h3>
                <button class="close-btn" onclick="closeModal('history')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div id="historyList" class="history-list">
                    <!-- History items will be injected here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('history')">Îã´Í∏∞</button>
            </div>
        </div>
    </div>

    <!-- Export Modal (Updated Structure with AI Polish) -->
    <div id="exportModal" class="modal-overlay">
        <div class="modal sheet-modal">
            <div class="modal-header">
                <h3 class="modal-title" style="color:black;">ÌÜµÌï© Í∏∞ÌöçÏÑú ÎØ∏Î¶¨Î≥¥Í∏∞</h3>
                <button class="close-btn" onclick="closeModal('export')" style="color:black;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body sheet-scroll">
                <!-- Loading Overlay for AI Generation -->
                <div id="exportLoading" class="loading-overlay" style="background: rgba(255,255,255,0.9); display:none;">
                    <div class="spinner" style="border-color: rgba(0,0,0,0.1); border-top-color: var(--accent-color);"></div>
                    <p style="color:black; margin-top:15px;">AIÍ∞Ä Î¨∏Ïû•ÏùÑ Îã§Îì¨Í≥† ÏûàÏäµÎãàÎã§...</p>
                </div>

                <!-- Markdown Based Layout -->
                <div class="sheet-container">
                    <div class="sheet-header-group">
                        <h1 class="sheet-title-main">ÏûëÌíàÍ∏∞ÌöçÏãúÌä∏</h1>
                        <div class="sheet-meta-info">
                            Ver. 2025-01-01 | Project ID: #PD_000_AB
                        </div>
                    </div>

                    <!-- 1. ÏûëÌíà Í∞úÏöî -->
                    <div class="sheet-section">
                        <div class="sheet-section-title">1. ÏûëÌíà Í∞úÏöî</div>
                        <div class="sheet-field">
                            <label class="sheet-field-label">Ï†úÎ™© (Í∞ÄÏ†ú)</label>
                            <input type="text" class="sheet-field-input short" id="sheetTitle" placeholder="Ï†úÎ™© ÏûÖÎ†•">
                        </div>
                        <div class="sheet-field">
                            <label class="sheet-field-label">ÌÉÄÍ≤ü / Ïû•Î•¥ / ÌîåÎû´Ìèº</label>
                            <input type="text" class="sheet-field-input short" id="sheetGenre" placeholder="Ïòà: 20ÎåÄ ÎÇ®ÏÑ± / Ïñ¥Î∞ò ÌåêÌÉÄÏßÄ / ÏõπÏÜåÏÑ§">
                        </div>
                        <div class="sheet-field">
                            <label class="sheet-field-label">Î°úÍ∑∏ÎùºÏù∏ (Ìïú Ï§Ñ ÏÜåÍ∞ú)</label>
                            <textarea id="sheetLogline" class="sheet-field-input medium" placeholder="ÏûëÌíàÏùÑ Ìïú Ï§ÑÎ°ú ÏöîÏïΩÌïòÏÑ∏Ïöî."></textarea>
                        </div>
                    </div>

                    <!-- 2. Ïª®ÏÖâ Î∞è ÏΩîÎìú -->
                    <div class="sheet-section">
                        <div class="sheet-section-title">2. Ïª®ÏÖâ Î∞è ÏΩîÎìú</div>
                        <div class="sheet-field">
                            <label class="sheet-field-label">ÌÇ§ÏõåÎìú / ÏΩîÎìú</label>
                            <textarea id="sheetKeywords" class="sheet-field-input medium" placeholder="ÏûëÌíàÏùò ÏÑ±Í≤©, Ïä§ÌÉÄÏùº (ex. Î®ºÏπòÌÇ®, ÏÇ¨Ïù¥Îã§)"></textarea>
                        </div>
                        <div class="sheet-field">
                            <label class="sheet-field-label">ÏïÑÏù¥ÌÖú (ÏÜåÏû¨) & ÌÅ¥Î¶¨ÏÖ∞ (ÏÑ§Ï†ï)</label>
                            <textarea id="sheetItems" class="sheet-field-input long" placeholder="ÏûêÎèô ÏûÖÎ†•Îê©ÎãàÎã§..."></textarea>
                        </div>
                    </div>

                    <!-- 3. Í∏∞Ìöç ÏùòÎèÑ -->
                    <div class="sheet-section">
                        <div class="sheet-section-title">3. Í∏∞Ìöç ÏùòÎèÑ (ÏÑúÏÇ¨ & Ïù∏Î¨º)</div>
                        <div class="sheet-field">
                            <label class="sheet-field-label">Í∏∞Ìöç ÏùòÎèÑ</label>
                            <textarea id="sheetIntention" class="sheet-field-input medium" placeholder="Ïù¥ ÏûëÌíàÏùÑ ÌÜµÌï¥ Ï†ÑÎã¨ÌïòÍ≥† Ïã∂ÏùÄ Í≤ÉÏùÄ?"></textarea>
                        </div>
                        <div class="sheet-field">
                            <label class="sheet-field-label">ÏÑ±Ïû• / Î∞©Ìï¥ / Í≥µÍ∞ê ÏöîÏÜå</label>
                            <textarea id="sheetElements" class="sheet-field-input long" placeholder="Ï£ºÏù∏Í≥µÏùò ÏÑ±Ïû• Î∞∞Í≤Ω, Î∞©Ìï¥Î¨º, ÎèÖÏûê Í≥µÍ∞ê Ìè¨Ïù∏Ìä∏ Îì±"></textarea>
                        </div>
                    </div>

                    <!-- 4. ÏãúÎÜâÏãúÏä§ Î∞è Î∞∞Í≤Ω -->
                    <div class="sheet-section">
                        <div class="sheet-section-title">4. ÏãúÎÜâÏãúÏä§ Î∞è Î∞∞Í≤Ω</div>
                        <div class="sheet-field">
                            <label class="sheet-field-label">ÏãúÎÜâÏãúÏä§ Î∞è ÏÑ∏Í≥ÑÍ¥Ä</label>
                            <textarea id="sheetSynopsis" class="sheet-field-input long" style="height: 300px;" placeholder="Î∞∞Í≤Ω ÏÑ§Ï†ïÏù¥ ÏûêÎèôÏúºÎ°ú ÏûÖÎ†•Îê©ÎãàÎã§."></textarea>
                        </div>
                    </div>

                    <!-- 5. Îì±Ïû•Ïù∏Î¨º -->
                    <div class="sheet-section">
                        <div class="sheet-section-title">5. Îì±Ïû•Ïù∏Î¨º (Ï∫êÎ¶≠ÌÑ∞)</div>
                        <div class="sheet-field">
                            <textarea id="sheetCharacters" class="sheet-field-input long" style="height: 400px;" placeholder="Ï∫êÎ¶≠ÌÑ∞ ÏÑ§Ï†ïÏù¥ ÏûêÎèôÏúºÎ°ú ÏûÖÎ†•Îê©ÎãàÎã§."></textarea>
                        </div>
                    </div>

                    <!-- 6. Î†àÌçºÎü∞Ïä§ -->
                    <div class="sheet-section">
                        <div class="sheet-section-title">6. Î†àÌçºÎü∞Ïä§</div>
                        <div class="sheet-field">
                            <label class="sheet-field-label">ÏΩîÏñ¥ / Ïù¥ÎØ∏ÏßÄ / Í∞êÏÑ±</label>
                            <textarea id="sheetRefs" class="sheet-field-input medium" placeholder="Ï∞∏Í≥†Ìïú ÏûëÌíàÏù¥ÎÇò Î∂ÑÏúÑÍ∏∞Î•º Ï†ÅÏñ¥Ï£ºÏÑ∏Ïöî."></textarea>
                        </div>
                    </div>

                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('export')">Îã´Í∏∞</button>
                
                <!-- AI Refine Button -->
                <button class="action-btn polish" onclick="refineSheetWithAI()" style="margin:0;">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> AIÎ°ú Î¨∏Ïû• Îã§Îì¨Í∏∞
                </button>

                <button class="btn-primary" onclick="printSheet()">
                    <i class="fa-solid fa-print"></i> PDFÎ°ú Ï†ÄÏû• / Ïù∏ÏáÑ
                </button>
            </div>
        </div>
    </div>
    
    <!-- Custom Alert Modal -->
    <div id="alertModal" class="modal-overlay">
        <div class="modal" style="width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">ÏïåÎ¶º</h3>
                <button class="close-btn" onclick="closeAlert()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body alert-modal-body">
                <p id="alertMessage" class="alert-message"></p>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn-primary" onclick="closeAlert()">ÌôïÏù∏</button>
            </div>
        </div>
    </div>

    <script>
        // Initial Data State
        let currentSlot = 1;
        const DEFAULT_DATA = [
            {
                id: 1,
                icon: "fa-solid fa-city",
                title: "Î∞∞Í≤Ω ÏÑ§Ï†ï",
                desc: "2025ÎÖÑ ÏÑúÏö∏, ÎßàÎ≤ïÏù¥ Ìï©Î≤ïÌôîÎêòÏñ¥ Í≥µÍ≥µÏû¨Î°ú ÏÇ¨Ïö©Îê®. ÌïòÏßÄÎßå Î¨¥ÌóàÍ∞Ä ÎßàÎ†• ÏÇ¨Ïö©ÏùÄ Ï§ëÎ≤îÏ£ÑÎ°ú Îã§Ïä§Î†§Ïßê. ÏùÑÏßÄÎ°úÍ∞Ä ÎßàÎ≤ï Í≥µÌïôÏùò Ï§ëÏã¨ÏßÄ.",
                tag: "Ïû•Î•¥: Ïñ¥Î∞ò ÌåêÌÉÄÏßÄ"
            },
            {
                id: 2,
                icon: "fa-solid fa-user-secret",
                title: "Ï£ºÏù∏Í≥µ: Í∞ïÏßÑÌòÅ",
                desc: "32ÏÑ∏, Í∑∏Î¶ºÏûê ÏÇ¨ÎÉ•Íæº(Î∂àÎ≤ï ÎßàÎ≤ïÏÇ¨ Ï∂îÏ†Å). ÎÉâÏÜåÏ†ÅÏù¥ÎÇò ÏùòÎ¢∞ÎπÑÏóêÎäî Ï≤†Ï†ÄÌï®. Í≥ºÍ±∞ 3ÎÖÑ Ï†Ñ Ìè≠Î∞ú ÏÇ¨Í≥†Ïùò Ïú†ÏùºÌïú ÏÉùÏ°¥Ïûê.",
                tag: "ÌäπÏÑ±: ÎßàÎ†• Í∞êÏßÄ"
            }
        ];
        
        let worldData = []; 
        let GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || '';
        let episodeHistory = JSON.parse(localStorage.getItem('episode_history')) || [];

        // --- Local Storage & Slots ---

        function loadWorldData(slot) {
            const key = `world_data_slot_${slot}`;
            const saved = localStorage.getItem(key);
            if (saved) {
                worldData = JSON.parse(saved);
            } else {
                worldData = JSON.parse(JSON.stringify(DEFAULT_DATA)); 
            }
            currentSlot = slot;
            updateSlotUI();
            renderCards();
        }

        function saveToLocal() {
            const key = `world_data_slot_${currentSlot}`;
            localStorage.setItem(key, JSON.stringify(worldData));
        }

        function switchSlot(slot) {
            loadWorldData(slot);
        }

        function updateSlotUI() {
            for(let i=1; i<=3; i++) {
                const btn = document.getElementById(`slot${i}`);
                if(i === currentSlot) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
        }

        loadWorldData(1); 

        // --- Mobile Tab Switching ---
        function switchMobileTab(tab) {
            const settingsPanel = document.getElementById('panelSettings');
            const generatePanel = document.getElementById('panelGenerate');
            const navItems = document.querySelectorAll('.nav-item');

            if (tab === 'settings') {
                settingsPanel.classList.add('active-tab');
                generatePanel.classList.remove('active-tab');
                navItems[0].classList.add('active');
                navItems[1].classList.remove('active');
            } else {
                settingsPanel.classList.remove('active-tab');
                generatePanel.classList.add('active-tab');
                navItems[0].classList.remove('active');
                navItems[1].classList.add('active');
            }
        }


        // Custom Alert Function
        function showAlert(msg) {
            document.getElementById('alertMessage').innerText = msg;
            document.getElementById('alertModal').classList.add('active');
        }
        function closeAlert() {
            document.getElementById('alertModal').classList.remove('active');
        }

        // Render Function
        function renderCards() {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';

            worldData.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'info-card';
                
                // Card Layout
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">
                            <i class="${item.icon}"></i> ${item.title}
                        </div>
                        <div class="card-actions">
                             <i class="fa-solid fa-pen action-icon edit-btn" title="ÏàòÏ†ï"></i>
                             <i class="fa-solid fa-trash action-icon delete delete-btn" title="ÏÇ≠Ï†ú"></i>
                        </div>
                    </div>
                    <div class="card-desc">${item.desc ? item.desc.replace(/\n/g, '<br>') : ''}</div>
                    ${item.tag ? `<span class="tag">${item.tag}</span>` : ''}
                `;
                
                // Main Card Click (Open Edit)
                card.addEventListener('click', (e) => {
                    openModal('edit', item.id);
                });

                // Edit Button specific (Same as card but just in case)
                const editBtn = card.querySelector('.edit-btn');
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    openModal('edit', item.id);
                });

                // Delete Button specific (Safe Event Listener)
                const deleteBtn = card.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    deleteCard(item.id);
                });

                container.appendChild(card);
            });
        }

        function deleteCard(id) {
            if(confirm("Ï†ïÎßê Ïù¥ ÏÑ§Ï†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                worldData = worldData.filter(item => item.id !== id);
                saveToLocal();
                renderCards();
            }
        }

        // Modal Functions
        function openModal(type, id = null) {
            if (type === 'edit') {
                const modal = document.getElementById('editModal');
                const titleEl = document.getElementById('modalTitle');
                const idEl = document.getElementById('settingId');
                const iconEl = document.getElementById('settingIcon');
                const titleInputEl = document.getElementById('settingTitle');
                const descEl = document.getElementById('settingDesc');
                const tagEl = document.getElementById('settingTag');

                if (id) {
                    const data = worldData.find(item => item.id === id);
                    if (!data) return;
                    titleEl.innerText = 'ÏÑ§Ï†ï ÏÉÅÏÑ∏ / ÏàòÏ†ï';
                    idEl.value = data.id;
                    
                    let iconExists = false;
                    for(let i=0; i < iconEl.options.length; i++){
                        if(iconEl.options[i].value === data.icon){
                            iconExists = true;
                            break;
                        }
                    }
                    if(!iconExists) {
                        let opt = document.createElement('option');
                        opt.value = data.icon;
                        opt.innerHTML = "‚ú® Í∏∞Ï°¥ ÏïÑÏù¥ÏΩò (" + data.icon + ")";
                        iconEl.appendChild(opt);
                    }
                    iconEl.value = data.icon;

                    titleInputEl.value = data.title;
                    descEl.value = data.desc;
                    tagEl.value = data.tag;
                } else {
                    titleEl.innerText = 'ÏÉà ÏÑ§Ï†ï Ï∂îÍ∞Ä';
                    idEl.value = '';
                    iconEl.value = 'fa-solid fa-book';
                    titleInputEl.value = '';
                    descEl.value = '';
                    tagEl.value = '';
                }
                modal.classList.add('active');
            } else if (type === 'api') {
                document.getElementById('apiKeyInput').value = GEMINI_API_KEY;
                document.getElementById('apiModal').classList.add('active');
            } else if (type === 'paste') {
                document.getElementById('pasteInput').value = '';
                document.getElementById('pasteModal').classList.add('active');
            } else if (type === 'history') {
                renderHistory();
                document.getElementById('historyModal').classList.add('active');
            } else if (type === 'export') {
                prepareExportSheet(); // Default basic fill
                document.getElementById('exportModal').classList.add('active');
            }
        }

        function closeModal(type) {
            if (type === 'edit') document.getElementById('editModal').classList.remove('active');
            if (type === 'api') document.getElementById('apiModal').classList.remove('active');
            if (type === 'paste') document.getElementById('pasteModal').classList.remove('active');
            if (type === 'history') document.getElementById('historyModal').classList.remove('active');
            if (type === 'export') document.getElementById('exportModal').classList.remove('active');
        }

        // Original Basic Prepare Function
        function prepareExportSheet() {
            // Auto-fill logic based on tags/icons (Basic)
            let synopsis = [];
            let characters = [];
            let items = [];
            let genre = "";

            worldData.forEach(item => {
                const title = item.title;
                const desc = item.desc;
                const tag = (item.tag || '').toLowerCase();
                const icon = item.icon;
                
                const entry = `[${title}]\n${desc}`;

                if (tag.includes('Ïù∏Î¨º') || tag.includes('character') || title.includes('Ï£ºÏù∏Í≥µ') || icon.includes('user')) {
                    characters.push(`### ${title}\n${desc}`);
                } else if (tag.includes('Î∞∞Í≤Ω') || tag.includes('location') || tag.includes('setting') || icon.includes('city') || icon.includes('map')) {
                    synopsis.push(entry);
                } else if (tag.includes('Ïû•Î•¥') || tag.includes('genre')) {
                    genre = desc; 
                } else {
                    items.push(entry); 
                }
            });

            document.getElementById('sheetGenre').value = genre || "";
            document.getElementById('sheetSynopsis').value = synopsis.join('\n\n');
            document.getElementById('sheetCharacters').value = characters.join('\n\n----------------\n\n');
            document.getElementById('sheetItems').value = items.join('\n\n');
        }

        // AI Refinement Function
        async function refineSheetWithAI() {
            if (!GEMINI_API_KEY) {
                showAlert("AI Ïó∞Í≤∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.\nÏÑ§Ï†ïÏóêÏÑú API KeyÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                return;
            }

            // Show Loading inside Modal
            const loading = document.getElementById('exportLoading');
            loading.style.display = 'flex';

            // Prepare Context
            const contextData = JSON.stringify(worldData);

            const prompt = `
                You are a professional editor for a novel project.
                Based on the following RAW World Settings, generate a Polished Project Sheet.
                
                RAW DATA:
                ${contextData}

                Instructions:
                1. **Title**: Suggest a creative title if missing.
                2. **Genre**: Define genre/target.
                3. **Logline**: Write a compelling 1-sentence hook.
                4. **Keywords**: Extract 3-5 keywords.
                5. **Intention**: Write a planning intention (Why this story?).
                6. **Synopsis**: Combine background settings into a smooth narrative flow (Synopsis).
                7. **Characters**: Describe characters with depth (Personality, Goal, Conflict).
                8. **Etc**: Other rules or items.
                
                Output JSON format:
                {
                    "title": "...",
                    "genre": "...",
                    "logline": "...",
                    "keywords": "...",
                    "intention": "...",
                    "elements": "...",
                    "synopsis": "...",
                    "characters": "...",
                    "items": "..."
                }
                Language: Korean.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { response_mime_type: "application/json" }
                    })
                });

                const data = await response.json();
                if(data.error) throw new Error(data.error.message);

                const text = data.candidates[0].content.parts[0].text;
                
                // Safe Cleaning
                const cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const result = JSON.parse(cleanText);

                // Safe Formatting Helper
                function formatValue(value) {
                    if (!value) return "";
                    if (typeof value === 'string') return value;
                    if (Array.isArray(value)) {
                        // Check if array of objects
                        if (value.length > 0 && typeof value[0] === 'object') {
                            return value.map(v => {
                                const parts = [];
                                if(v.name || v.title) parts.push(`[${v.name || v.title}]`);
                                if(v.desc || v.description) parts.push(v.desc || v.description);
                                return parts.join(' ');
                            }).join('\n\n');
                        }
                        return value.join(', ');
                    }
                    if (typeof value === 'object') {
                        return Object.entries(value).map(([k, v]) => `${k}: ${v}`).join('\n');
                    }
                    return String(value);
                }

                // Fill Fields with Formatting
                document.getElementById('sheetTitle').value = formatValue(result.title);
                document.getElementById('sheetGenre').value = formatValue(result.genre);
                document.getElementById('sheetLogline').value = formatValue(result.logline);
                document.getElementById('sheetKeywords').value = formatValue(result.keywords);
                document.getElementById('sheetIntention').value = formatValue(result.intention);
                document.getElementById('sheetElements').value = formatValue(result.elements); 
                document.getElementById('sheetSynopsis').value = formatValue(result.synopsis);
                document.getElementById('sheetCharacters').value = formatValue(result.characters);
                document.getElementById('sheetItems').value = formatValue(result.items);

                showAlert("AIÍ∞Ä Í∏∞ÌöçÏÑúÎ•º Îã§Îì¨ÏóàÏäµÎãàÎã§!");

            } catch (e) {
                showAlert(`AI ÏÉùÏÑ± Ï§ë Ïò§Î•ò Î∞úÏÉù: ${e.message}`);
                console.error(e);
            } finally {
                loading.style.display = 'none';
            }
        }

        function printSheet() {
            // 1. Auto-resize textareas for printing
            const textareas = document.querySelectorAll('.sheet-textarea, .sheet-field-input');
            textareas.forEach(ta => {
                ta.style.height = 'auto'; // Reset
                ta.style.height = (ta.scrollHeight + 5) + 'px'; // Expand to fit content
            });
            
            // 2. Trigger Print
            window.print();
        }

        function saveSetting() {
            const id = document.getElementById('settingId').value;
            const icon = document.getElementById('settingIcon').value;
            const title = document.getElementById('settingTitle').value;
            const desc = document.getElementById('settingDesc').value;
            const tag = document.getElementById('settingTag').value;

            if (!title || !desc) {
                showAlert('Ï†úÎ™©Í≥º ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            if (id) {
                const index = worldData.findIndex(item => item.id == id);
                if (index !== -1) worldData[index] = { id: parseInt(id), icon, title, desc, tag };
            } else {
                const newId = worldData.length > 0 ? Math.max(...worldData.map(d => d.id)) + 1 : 1;
                worldData.push({ id: newId, icon, title, desc, tag });
            }
            saveToLocal(); 
            renderCards();
            closeModal('edit');
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) {
                showAlert('API ÌÇ§Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            GEMINI_API_KEY = key;
            localStorage.setItem('gemini_api_key', key);
            showAlert('API ÌÇ§Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.\nÏù¥Ï†ú AI Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.');
            closeModal('api');
        }

        // File Upload Handling
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            if (!GEMINI_API_KEY) {
                showAlert("AI Ïó∞Í≤∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.\nÏö∞Ï∏° ÏÉÅÎã®Ïùò ÌÜ±ÎãàÎ∞îÌÄ¥ Î≤ÑÌäºÏùÑ ÎàåÎü¨\nAPI KeyÎ•º Î®ºÏ†Ä Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.");
                input.value = ''; 
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                analyzeAndImportSettings(content);
            };
            reader.onerror = function(e) {
                showAlert("ÌååÏùº ÏùΩÍ∏∞ Ïã§Ìå®. Í∂åÌïú Î¨∏Ï†úÏùº Ïàò ÏûàÏäµÎãàÎã§.\n[Î∂ôÏó¨ÎÑ£Í∏∞] Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©Ìï¥Î≥¥ÏÑ∏Ïöî.");
            }
            reader.readAsText(file);
        }

        // Paste Handling
        function handlePasteAnalysis() {
            const text = document.getElementById('pasteInput').value;
            if(!text.trim()) {
                showAlert("ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                return;
            }
            if (!GEMINI_API_KEY) {
                showAlert("AI Ïó∞Í≤∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.\nAPI KeyÎ•º Î®ºÏ†Ä Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.");
                return;
            }
            closeModal('paste');
            analyzeAndImportSettings(text);
        }

        // NEW: Reflect Episode to World Settings
        async function reflectToSettings() {
            const rawText = document.getElementById('rawEpisodeText').value;
            if(!rawText) {
                showAlert("Î∞òÏòÅÌï† ÏóêÌîºÏÜåÎìú ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.");
                return;
            }
            if (!GEMINI_API_KEY) {
                showAlert("AI Ïó∞Í≤∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
                return;
            }

            const loading = document.getElementById('leftLoading');
            document.getElementById('leftLoadingText').innerText = "ÏóêÌîºÏÜåÎìú Î∂ÑÏÑù Î∞è Î∞òÏòÅ Ï§ë...";
            loading.style.display = 'flex';

            const existingTitles = worldData.map(d => d.title).join(", ");

            const prompt = `
                Analyze the provided STORY EPISODE and extract NEW or UPDATED world setting elements (Characters, Places, Rules).
                
                Instructions:
                1. If an element exists in the Current Settings list: "${existingTitles}", create an entry with the SAME TITLE and provide ONLY the NEW facts/events from this episode to append to its history.
                2. If it's a completely new element, create a full entry.
                3. Language: Korean.
                
                Input Story:
                """${rawText}"""
            `;

            const generationConfig = {
                response_mime_type: "application/json",
                response_schema: {
                    type: "OBJECT",
                    properties: {
                        settings: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    title: { type: "STRING" },
                                    desc: { type: "STRING" },
                                    tag: { type: "STRING" },
                                    icon: { type: "STRING" }
                                },
                                required: ["title", "desc", "tag", "icon"]
                            }
                        }
                    }
                }
            };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: generationConfig
                    })
                });

                const data = await response.json();
                if(data.error) throw new Error(data.error.message);

                const text = data.candidates[0].content.parts[0].text;
                const result = JSON.parse(text);
                const items = result.settings || result;

                let updatedCount = 0;
                let newCount = 0;

                items.forEach(newItem => {
                    const index = worldData.findIndex(d => d.title === newItem.title);
                    if(index !== -1) {
                        const existing = worldData[index];
                        if(!existing.desc.includes(newItem.desc)) {
                            existing.desc += `\n\n[Ï∂îÍ∞ÄÎê®]: ${newItem.desc}`;
                            updatedCount++;
                        }
                    } else {
                        let newId = worldData.length > 0 ? Math.max(...worldData.map(d => d.id)) + 1 : 1;
                        while(worldData.find(d => d.id === newId)) newId++;
                        
                        newItem.id = newId;
                        worldData.push(newItem);
                        newCount++;
                    }
                });

                saveToLocal();
                renderCards();
                showAlert(`Î∞òÏòÅ ÏôÑÎ£å!\n- ÏÉàÎ°úÏö¥ ÏÑ§Ï†ï: ${newCount}Í∞ú\n- ÏóÖÎç∞Ïù¥Ìä∏Îêú ÏÑ§Ï†ï: ${updatedCount}Í∞ú`);

            } catch (e) {
                showAlert(`Î∞òÏòÅ Ï§ë Ïò§Î•ò Î∞úÏÉù: ${e.message}`);
                console.error(e);
            } finally {
                loading.style.display = 'none';
                document.getElementById('leftLoadingText').innerText = "Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Ï§ë...";
            }
        }

        async function analyzeAndImportSettings(fileContent) {
            const loading = document.getElementById('leftLoading');
            loading.style.display = 'flex';

            const prompt = `
                Analyze the provided text and extract story settings.
                Language: Korean.
                
                Text: """${fileContent}"""
            `;

            const generationConfig = {
                response_mime_type: "application/json",
                response_schema: {
                    type: "OBJECT",
                    properties: {
                        settings: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    title: { type: "STRING" },
                                    desc: { type: "STRING" },
                                    tag: { type: "STRING" },
                                    icon: { type: "STRING" }
                                },
                                required: ["title", "desc", "tag", "icon"]
                            }
                        }
                    }
                }
            };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: generationConfig
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                const text = data.candidates[0].content.parts[0].text;
                const result = JSON.parse(text);
                const newSettings = result.settings || result;

                let currentId = worldData.length > 0 ? Math.max(...worldData.map(d => d.id)) : 0;
                newSettings.forEach(item => {
                    currentId++;
                    item.id = currentId;
                    worldData.push(item);
                });

                saveToLocal();
                renderCards();
                showAlert(`${newSettings.length}Í∞úÏùò ÏÑ§Ï†ïÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!`);

            } catch (error) {
                showAlert(`Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:\n${error.message}`);
            } finally {
                loading.style.display = 'none';
                document.getElementById('fileUpload').value = ''; 
            }
        }


        // Episode Generation Logic
        async function generateEpisode() {
            const inputVal = document.getElementById('eventInput').value;
            const placeholder = document.getElementById('placeholder');
            const loading = document.getElementById('loading');
            const result = document.getElementById('resultContent');

            if (!inputVal) {
                showAlert("ÏÇ¨Í±¥ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!");
                return;
            }
            if (!GEMINI_API_KEY) {
                showAlert("AI Ïó∞Í≤∞ ÏÑ§Ï†ïÏóêÏÑú API KeyÎ•º Î®ºÏ†Ä Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî!");
                openModal('api');
                return;
            }

            placeholder.style.display = 'none';
            result.style.display = 'none';
            loading.style.display = 'flex';

            const worldContext = worldData.map(item => 
                `[${item.title}] (${item.tag || 'ÏÑ§Ï†ï'}): ${item.desc}`
            ).join('\n\n');

            const prompt = `
                ÎÑàÎäî ÏÜåÏÑ§ Ï∞ΩÏûë Î≥¥Ï°∞ AIÏïº. ÏïÑÎûòÏùò [ÏÑ∏Í≥ÑÍ¥Ä ÏÑ§Ï†ï]ÏùÑ Ï≤†Ï†ÄÌûà Ï§ÄÏàòÌï¥ÏÑú, [Î∞úÏÉù ÏÇ¨Í±¥]Ïóê ÎåÄÌïú ÏóêÌîºÏÜåÎìú Ï¥àÏïàÏùÑ ÏûëÏÑ±Ìï¥Ï§ò.
                
                === [ÏÑ∏Í≥ÑÍ¥Ä ÏÑ§Ï†ï] ===
                ${worldContext}
                
                === [Î∞úÏÉù ÏÇ¨Í±¥] ===
                ${inputVal}
                
                === [ÏöîÏ≤≠ ÏÇ¨Ìï≠] ===
                1. Îì±Ïû•Ïù∏Î¨ºÏùò ÏÑ±Í≤©Í≥º Î∞∞Í≤Ω ÏÑ§Ï†ïÏùÑ Î∞òÏòÅÌïú ÎåÄÏÇ¨(Dialogue) ÏúÑÏ£ºÎ°ú ÏûëÏÑ±Ìï† Í≤É.
                2. ÏÑ∏Í≥ÑÍ¥ÄÏùò Í∑úÏπô(ÎßàÎ≤ï Îì±)Ïù¥ ÏÇ¨Í±¥ Ìï¥Í≤∞Ïù¥ÎÇò Í∞àÎì± Ïã¨ÌôîÏóê Ïñ¥ÎñªÍ≤å ÏûëÏö©ÌïòÎäîÏßÄ Î¨òÏÇ¨Ìï† Í≤É.
                3. Ïû•Î©¥(Scene) Îã®ÏúÑÎ°ú ÎÇòÎàÑÏñ¥ 3~4Í∞úÏùò Ï£ºÏöî Ïû•Î©¥ÏùÑ ÏÑúÏà†Ìï¥Ï§ò.
                4. Î¨∏Ï≤¥Îäî ÏÜåÏÑ§ Î≥∏Î¨∏Ï≤òÎüº Î™∞ÏûÖÍ∞ê ÏûàÍ≤å ÏûëÏÑ±Ìï¥.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                const generatedText = data.candidates[0].content.parts[0].text;

                saveToHistory(inputVal, generatedText);

                loading.style.display = 'none';
                result.innerHTML = formatOutput(generatedText, inputVal);
                result.style.display = 'block';

            } catch (error) {
                loading.style.display = 'none';
                showAlert(`Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`);
            }
        }

        function formatOutput(text, eventName) {
            let formatted = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            const rawText = text.replace(/\*\*/g, '');
            const safeEventName = eventName.replace(/'/g, "\\'");
            
            return `
                <h3><i class="fa-solid fa-clapperboard"></i> ÏÉùÏÑ±Îêú ÏóêÌîºÏÜåÎìú</h3>
                <p style="color: var(--text-sub); font-size: 0.9rem; margin-bottom: 20px;">
                    Î∂ÑÏÑùÎêú ÏÇ¨Í±¥: <span style="color: white;">${eventName}</span>
                </p>
                <div id="episodeText" class="chat-bubble">
                    ${formatted.replace(/\n/g, '<br>')}
                </div>
                
                <div class="result-actions">
                    <button class="action-btn secondary reflect" onclick="reflectToSettings()">
                        <i class="fa-solid fa-retweet"></i> ÏõîÎìúÏÑ∏ÌåÖÏóê Î∞òÏòÅ (Î∂ÑÏÑù & Ï∂îÍ∞Ä)
                    </button>
                    <button class="action-btn secondary" onclick="copyToClipboard()">
                        <i class="fa-regular fa-copy"></i> ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨
                    </button>
                    <button class="action-btn secondary" onclick="downloadEpisode('${safeEventName}')">
                        <i class="fa-solid fa-download"></i> ÌÖçÏä§Ìä∏ Ï†ÄÏû• (.txt)
                    </button>
                </div>
                <textarea id="rawEpisodeText" style="display:none;">${rawText}</textarea>
            `;
        }

        // Feature: Download as Text File
        function downloadEpisode(eventName) {
            const rawText = document.getElementById('rawEpisodeText').value;
            const title = `Episode_${eventName.substring(0, 10).replace(/\s/g, '_')}.txt`;
            
            const blob = new Blob([rawText], { type: "text/plain;charset=utf-8" });
            const anchor = document.createElement("a");
            
            anchor.href = URL.createObjectURL(blob);
            anchor.download = title;
            anchor.style.display = "none";
            document.body.appendChild(anchor);
            anchor.click();
            document.body.removeChild(anchor);
        }

        // Feature: Copy to Clipboard
        function copyToClipboard() {
            const rawText = document.getElementById('rawEpisodeText').value;
            
            const el = document.createElement('textarea');
            el.value = rawText;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            
            showAlert("ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.\nÍµ¨Í∏Ä Î¨∏ÏÑúÎÇò Î©îÎ™®Ïû•Ïóê Î∂ôÏó¨ÎÑ£Í∏∞(Ctrl+V) ÌïòÏÑ∏Ïöî.");
        }

        // --- History Features ---

        function saveToHistory(event, content) {
            const newEntry = {
                id: Date.now(),
                date: new Date().toLocaleString(),
                event: event,
                content: content
            };
            episodeHistory.unshift(newEntry);
            localStorage.setItem('episode_history', JSON.stringify(episodeHistory));
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';

            if (episodeHistory.length === 0) {
                list.innerHTML = '<div class="empty-history"><i class="fa-solid fa-box-open" style="font-size: 2rem; margin-bottom:12px;"></i><br>Ï†ÄÏû•Îêú ÌûàÏä§ÌÜ†Î¶¨Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }

            episodeHistory.forEach(item => {
                const preview = item.content.substring(0, 100) + '...';
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'history-item';
                itemDiv.innerHTML = `
                    <div class="history-meta">
                        <span>${item.date}</span>
                    </div>
                    <div class="history-event">${item.event}</div>
                    <div class="history-preview">${preview}</div>
                    <div class="history-actions">
                        <button class="history-btn" onclick="loadHistory(${item.id})">
                            <i class="fa-solid fa-folder-open"></i> Î∂àÎü¨Ïò§Í∏∞
                        </button>
                        <button class="history-btn delete" onclick="deleteHistory(${item.id})">
                            <i class="fa-solid fa-trash"></i> ÏÇ≠Ï†ú
                        </button>
                    </div>
                `;
                list.appendChild(itemDiv);
            });
        }

        function loadHistory(id) {
            const item = episodeHistory.find(entry => entry.id === id);
            if (item) {
                document.getElementById('eventInput').value = item.event;
                const result = document.getElementById('resultContent');
                document.getElementById('placeholder').style.display = 'none';
                result.innerHTML = formatOutput(item.content, item.event);
                result.style.display = 'block';
                closeModal('history');
            }
        }

        function deleteHistory(id) {
            if(confirm("Ï†ïÎßê Ïù¥ Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                episodeHistory = episodeHistory.filter(entry => entry.id !== id);
                localStorage.setItem('episode_history', JSON.stringify(episodeHistory));
                renderHistory();
            }
        }

        renderCards();
    </script>
</body>
</html>
